<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!--  This file is generated by Nim. -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Favicon -->
<link rel="shortcut icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAUAAAAF////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAIAAABbAAAAlQAAAKIAAACbAAAAmwAAAKIAAACVAAAAWwAAAAL///8A////AP///wD///8A////AAAAABQAAADAAAAAYwAAAA3///8A////AP///wD///8AAAAADQAAAGMAAADAAAAAFP///wD///8A////AP///wAAAACdAAAAOv///wD///8A////AP///wD///8A////AP///wD///8AAAAAOgAAAJ3///8A////AP///wAAAAAnAAAAcP///wAAAAAoAAAASv///wD///8A////AP///wAAAABKAAAAKP///wAAAABwAAAAJ////wD///8AAAAAgQAAABwAAACIAAAAkAAAAJMAAACtAAAAFQAAABUAAACtAAAAkwAAAJAAAACIAAAAHAAAAIH///8A////AAAAAKQAAACrAAAAaP///wD///8AAAAARQAAANIAAADSAAAARf///wD///8AAAAAaAAAAKsAAACk////AAAAADMAAACcAAAAnQAAABj///8A////AP///wAAAAAYAAAAGP///wD///8A////AAAAABgAAACdAAAAnAAAADMAAAB1AAAAwwAAAP8AAADpAAAAsQAAAE4AAAAb////AP///wAAAAAbAAAATgAAALEAAADpAAAA/wAAAMMAAAB1AAAAtwAAAOkAAAD/AAAA/wAAAP8AAADvAAAA3gAAAN4AAADeAAAA3gAAAO8AAAD/AAAA/wAAAP8AAADpAAAAtwAAAGUAAAA/AAAA3wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAADfAAAAPwAAAGX///8A////AAAAAEgAAADtAAAAvwAAAL0AAADGAAAA7wAAAO8AAADGAAAAvQAAAL8AAADtAAAASP///wD///8A////AP///wD///8AAAAAO////wD///8A////AAAAAIcAAACH////AP///wD///8AAAAAO////wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A//8AAP//AAD4HwAA7/cAAN/7AAD//wAAoYUAAJ55AACf+QAAh+EAAAAAAADAAwAA4AcAAP5/AAD//wAA//8AAA=="/>
<link rel="icon" type="image/png" sizes="32x32" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAA3XAAAN1wFCKJt4AAAAB3RJTUUH4QQQEwksSS9ZWwAAAk1JREFUWMPtll2ITVEUx39nn/O7Y5qR8f05wtCUUr6ZIS++8pEnkZInPImneaCQ5METNdOkeFBKUhMPRIkHKfEuUZSUlGlKPN2TrgfncpvmnntnmlEyq1Z7t89/rf9a6+y99oZxGZf/XeIq61EdtgKXgdXA0xrYAvBjOIF1AI9zvjcC74BSpndrJPkBWDScTF8Aa4E3wDlgHbASaANmVqlcCnwHvgDvgVfAJ+AikAAvgfVZwLnSVZHZaOuKoQi3ZOMi4NkYkpe1p4J7A8BpYAD49hfIy/oqG0+hLomiKP2L5L+1ubn5115S+3OAn4EnwBlgMzCjyt6ZAnQCJ4A7wOs88iRJHvw50HoujuPBoCKwHWiosy8MdfZnAdcHk8dxXFJ3VQbQlCTJvRBCGdRbD4M6uc5glpY3eAihpN5S5w12diSEcCCEcKUO4ljdr15T76ur1FDDLIQQ3qv71EdDOe3Kxj3leRXyk+pxdWnFWod6Wt2bY3de3aSuUHcPBVimHs7mK9WrmeOF6lR1o9qnzskh2ar2qm1qizpfXaPeVGdlmGN5pb09qMxz1Xb1kLqgzn1RyH7JUXW52lr5e/Kqi9qpto7V1atuUzfnARrV7jEib1T76gG2qxdGmXyiekkt1GswPTtek0aBfJp6YySGBfWg2tPQ0FAYgf1stUfdmdcjarbYJEniKIq6gY/Aw+zWHAC+p2labGpqiorFYgGYCEzN7oQdQClN07O1/EfDyGgC0ALMBdYAi4FyK+4H3gLPsxfR1zRNi+NP7nH5J+QntnXe5B5mpfQAAAAASUVORK5CYII=">

<!-- Google fonts -->
<link href='https://fonts.googleapis.com/css?family=Lato:400,600,900' rel='stylesheet' type='text/css'/>
<link href='https://fonts.googleapis.com/css?family=Source+Code+Pro:400,500,600' rel='stylesheet' type='text/css'/>

<!-- CSS -->
<title>cpstut</title>
<link rel="stylesheet" type="text/css" href="nimdoc.out.css">

<script type="text/javascript" src="dochack.js"></script>

<script type="text/javascript">
function main() {
  var pragmaDots = document.getElementsByClassName("pragmadots");
  for (var i = 0; i < pragmaDots.length; i++) {
    pragmaDots[i].onclick = function(event) {
      // Hide tease
      event.target.parentNode.style.display = "none";
      // Show actual
      event.target.parentNode.nextElementSibling.style.display = "inline";
    }
  }

  const toggleSwitch = document.querySelector('.theme-switch input[type="checkbox"]');
  function switchTheme(e) {
      if (e.target.checked) {
          document.documentElement.setAttribute('data-theme', 'dark');
          localStorage.setItem('theme', 'dark');
      } else {
          document.documentElement.setAttribute('data-theme', 'light');
          localStorage.setItem('theme', 'light');
      }
  }

  toggleSwitch.addEventListener('change', switchTheme, false);

  const currentTheme = localStorage.getItem('theme') ? localStorage.getItem('theme') : null;
  if (currentTheme) {
    document.documentElement.setAttribute('data-theme', currentTheme);

    if (currentTheme === 'dark') {
      toggleSwitch.checked = true;
    }
  }
}

window.addEventListener('DOMContentLoaded', main);
</script>

</head>
<body>
<div class="document" id="documentId">
  <div class="container">
    <h1 class="title">cpstut</h1>
    
<h1 id="introduction">Introduction</h1><p>What you are reading is a little tutorial to get started with Nim CPS. This document will introduce the essential parts of the CPS API to get you started writing your own CPS programs.</p>
<p>The latest greatest CPS can be found at <a class="reference external" href="https://github.com/disruptek/cps">https://github.com/disruptek/cps</a></p>
<p>If you are not familiar with the concept of CPS I recomment first reading up a bit on the background: <a class="reference external" href="https://github.com/zevv/cpsdoc">https://github.com/zevv/cpsdoc</a></p>

<h2 id="baby-stepscolon-my-first-cps-program">Baby steps: my first cps program</h2><p>The complete code for this chapter can be found at <a class="reference external" href="https://github.com/zevv/cpstut/blob/master/cpstut1.nim">https://github.com/zevv/cpstut/blob/master/cpstut1.nim</a></p>
<p>cps is available as a regular nim library that you must import before cps is available in your program. The module offers a number of macros and templates, for details refer to the module documentation at <a class="reference external" href="https://disruptek.github.io/cps/cps.html">https://disruptek.github.io/cps/cps.html</a></p>
<p>So we start with the import:</p>
<p><pre class="listing"><span class="Keyword">import</span> <span class="Identifier">cps</span>
</pre></p>
<p>At the heart of CPS lies the <tt class="docutils literal"><span class="pre">Continuation</span></tt> type. In our implementation, this is just a regular Nim object that is inheritable. This is what the type looks like:</p>
<p><pre class="listing"><span class="Identifier">Continuation</span> <span class="Operator">=</span> <span class="Keyword">ref</span> <span class="Keyword">object</span> <span class="Keyword">of</span> <span class="Identifier">RootObj</span>
   <span class="Identifier">fn</span><span class="Operator">*:</span> <span class="Keyword">proc</span> <span class="Punctuation">(</span><span class="Identifier">c</span><span class="Punctuation">:</span> <span class="Identifier">Continuation</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Identifier">Continuation</span> <span class="Punctuation">{</span><span class="Operator">.</span><span class="Identifier">nimcall</span><span class="Operator">.</span><span class="Punctuation">}</span>
   <span class="Operator">...</span>
</pre></p>
<p>The object has a few more fields which are used for the CPS implementation internally, but one of the fields is very important for the users of cps, which is <tt class="docutils literal"><span class="pre">fn</span></tt>, the function pointer that makes CPS continuations tick. We'll get back to its use later.</p>
<p>To start with CPS, you would typically define your own object, inherited from the cps Continuation type, like so</p>
<p><pre class="listing"><span class="Keyword">type</span>
  <span class="Identifier">MyCont</span> <span class="Operator">=</span> <span class="Keyword">ref</span> <span class="Keyword">object</span> <span class="Keyword">of</span> <span class="Identifier">Continuation</span>
</pre></p>
<p>At a later time we will add our own fields to the derived Continuation objects, but for now we'll start out simple.</p>

<h2 id="the-cps-transform-macro">The CPS transform macro</h2><p>Next to the continuation type, the cps macro is the other important part for writing CPS programs, this is the macro that will be applied to any Nim functions we want to transform to CPS style. This macro does two jobs:</p>
<ul class="simple"><li>it will split the Nim function into a number of separate functions that we can independently; each of these functions is what we call a &quot;Leg&quot;.</li>
<li>it will create a new object type that is derived from our <tt class="docutils literal"><span class="pre">MyCont</span></tt>, on which it will store all function arguments and local variables. This type is opaque to us and is only used by CPS internally.</li>
</ul>
<p>The cps macro is a bit special, as it is typed: when calling the macro, the user needs to specify the type on which the macro should operate, and this type needs to be a derivative of the Continuation root object. This is what the notation looks like:</p>
<p><pre class="listing"><span class="Keyword">proc</span> <span class="Identifier">hello</span><span class="Punctuation">(</span><span class="Punctuation">)</span> <span class="Punctuation">{</span><span class="Operator">.</span><span class="Identifier">cps</span><span class="Punctuation">:</span><span class="Identifier">MyCont</span><span class="Operator">.</span><span class="Punctuation">}</span> <span class="Operator">=</span>
  <span class="Identifier">echo</span> <span class="StringLit">&quot;Hello, world!&quot;</span>
</pre></p>
<p>Congratulations! We have now written our very first CPS program. Nim will now know all that is needed to do the transformation on our procedure at compile time so it will run our code in CPS style.</p>
<p>The next thing to do would be to run our CPS transformed function. This involves a few steps we'll go through:</p>
<p>We start with instantiating the continuation: this means CPS will allocate a continuation object and prepare it so that it will point to the first leg of our function. Creating this instance is done with the <tt class="docutils literal"><span class="pre">whelp</span></tt> macro, and looks like this:</p>
<p>TODO: I still hate whelp. not the word, but the fact that we need it at all. I'd rather just do var c = hello(). Yeah yeah I know.</p>
<p><pre class="listing"><span class="Keyword">var</span> <span class="Identifier">c</span><span class="Punctuation">:</span> <span class="Identifier">Continuation</span> <span class="Operator">=</span> <span class="Identifier">whelp</span> <span class="Identifier">hello</span><span class="Punctuation">(</span><span class="Punctuation">)</span>
</pre></p>
<p>For technical reasons, the whelp macro returns a derived type, which we need to convert back to the <tt class="docutils literal"><span class="pre">Continuation</span></tt> type to be able to work with it.</p>
<p>TODO: Is there really no way around this?</p>
<p>Our continuation is now ready to be run; in fact, it has already started! There is a little function to check the state of a continuation, and the one above is now in the state called <tt class="docutils literal"><span class="pre">Running</span></tt>. You can inspect the current state of a continuation like this:</p>
<p><pre class="listing"><span class="Identifier">doAssert</span> <span class="Identifier">c</span><span class="Operator">.</span><span class="Identifier">state</span> <span class="Operator">==</span> <span class="Identifier">Running</span>
</pre></p>
<p>or, shorter:</p>
<p><pre class="listing"><span class="Identifier">doAssert</span> <span class="Identifier">c</span><span class="Operator">.</span><span class="Identifier">running</span><span class="Punctuation">(</span><span class="Punctuation">)</span>
</pre></p>
<p>Now, to run the rest of our function (_<a class="reference external" href="#continue">continue</a> it!), we need to do a little function call dance, which in the world of CPS is called <tt class="docutils literal"><span class="pre">trampolining</span></tt>: we call the <tt class="docutils literal"><span class="pre">fn()</span></tt> proc that is in the object, and pass the object itself to it. The result of this function call is again a continuation. Calling the <tt class="docutils literal"><span class="pre">fn()</span></tt> function once will run exactly one leg of our function:</p>
<p><pre class="listing"><span class="Identifier">c</span> <span class="Operator">=</span> <span class="Identifier">c</span><span class="Operator">.</span><span class="Identifier">fn</span><span class="Punctuation">(</span><span class="Identifier">c</span><span class="Punctuation">)</span>
</pre></p>
<p>The result of the above call will be &quot;Hello, world!&quot; printed to your terminal!</p>
<p>Our original function was not very exciting and did not do much; after printing the text, it is done and finished - all the work could be done in one single leg. This means the continuation is now done and complete:</p>
<p><pre class="listing"><span class="Identifier">doAssert</span> <span class="Identifier">c</span><span class="Operator">.</span><span class="Identifier">state</span> <span class="Operator">==</span> <span class="Identifier">Finished</span>
</pre></p>
<p>or again, the shorthand</p>
<p><pre class="listing"><span class="Identifier">doAssert</span> <span class="Identifier">c</span><span class="Operator">.</span><span class="Identifier">finished</span><span class="Punctuation">(</span><span class="Punctuation">)</span>
</pre></p>
<p>In real life, your CPS functions will have more then one leg. You would typically want to call the <tt class="docutils literal"><span class="pre">fn()</span></tt> proc repeatedly until the continunation is no longer running. This is a typical CPS idiom, and looks like this:</p>
<p><pre class="listing"><span class="Keyword">while</span> <span class="Identifier">c</span><span class="Operator">.</span><span class="Identifier">running</span><span class="Punctuation">:</span>
  <span class="Identifier">c</span> <span class="Operator">=</span> <span class="Identifier">c</span><span class="Operator">.</span><span class="Identifier">fn</span><span class="Punctuation">(</span><span class="Identifier">c</span><span class="Punctuation">)</span>
</pre></p>
<p>Running the continuation legs in a row is called &quot;trampolining&quot;, look at the diagram below to see why:</p>
<p><pre class="listing">
whelp &gt;--.     ,---.     ,---.     ,---.     ,---.     ,--&gt; finished
          \   /     v   /     v   /     v   /     v   /
         +-----+   +-----+   +-----+   +-----+   +-----+
         | leg |   | leg |   | leg |   | leg |   | leg |
         +-----+   +-----+   +-----+   +-----+   +-----+
</pre></p>

<h2 id="a-more-elaborate-examplecolon-cooperative-scheduling">A more elaborate example: cooperative scheduling</h2><p>The complete code for this chapter can be found at <a class="reference external" href="https://github.com/zevv/cpstut/blob/master/cpstut2.nim">https://github.com/zevv/cpstut/blob/master/cpstut2.nim</a></p>
<p>The above function was pretty simply and minimal, as it was transformed to only one single leg; it served the purpose of showing how to instantiate and run a CPS function.</p>
<p>Let's go a bit deeper now. The essence of CPS is that our functions can be split into legs that can be run at leisure; one typical example of this would be cooperative scheduling, where we can run multiple CPS functions concurrently.</p>
<p>For a simple example, let's write a little function with a loop - just a normal regular Nim function, which we will change later to run concurrent using CPS:</p>
<p><pre class="listing"><span class="Keyword">proc</span> <span class="Identifier">runner1</span><span class="Punctuation">(</span><span class="Identifier">name</span><span class="Punctuation">:</span> <span class="Identifier">string</span><span class="Punctuation">)</span> <span class="Operator">=</span>
  <span class="Keyword">var</span> <span class="Identifier">i</span> <span class="Operator">=</span> <span class="DecNumber">0</span>
  <span class="Keyword">while</span> <span class="Identifier">i</span> <span class="Operator">&lt;</span> <span class="DecNumber">4</span><span class="Punctuation">:</span>
    <span class="Identifier">inc</span> <span class="Identifier">i</span>
    <span class="Identifier">echo</span> <span class="Identifier">name</span><span class="Punctuation">,</span> <span class="StringLit">&quot; &quot;</span><span class="Punctuation">,</span> <span class="Identifier">i</span>
</pre></p>
<p>So let's call the function to see if it works:</p>
<p><pre class="listing"><span class="Identifier">runner1</span><span class="Punctuation">(</span><span class="StringLit">&quot;donkey&quot;</span><span class="Punctuation">)</span>
</pre></p>
<p>The output of this function call looks like this:</p>
<p><pre class="listing">
donkey 1
donkey 2
donkey 3
donkey 4
</pre></p>
<p>Now let's see how we can leverage CPS to run multiple instances of this function concurrently!</p>
<p>Let's start with a place to store the continuations that we want to run. A deque is a good fit for this, this is a first-in-first-out queue where we can add new continuations on one side, and take them off to run them from the other side:</p>
<p><pre class="listing"><span class="Keyword">import</span> <span class="Identifier">deques</span>

<span class="Keyword">var</span> <span class="Identifier">work</span><span class="Punctuation">:</span> <span class="Identifier">Deque</span><span class="Punctuation">[</span><span class="Identifier">Continuation</span><span class="Punctuation">]</span>
</pre></p>
<p>Now we need some code to run with this work queue. It will have a pretty simple job: it takes one continuation of the queue and trampolines it until it is no longer running, and repeat until there is no more work on the queue:</p>
<p><pre class="listing"><span class="Keyword">proc</span> <span class="Identifier">runWork</span><span class="Punctuation">(</span><span class="Punctuation">)</span> <span class="Operator">=</span>
  <span class="Keyword">while</span> <span class="Identifier">work</span><span class="Operator">.</span><span class="Identifier">len</span> <span class="Operator">&gt;</span> <span class="DecNumber">0</span><span class="Punctuation">:</span>
    <span class="Keyword">var</span> <span class="Identifier">c</span> <span class="Operator">=</span> <span class="Identifier">work</span><span class="Operator">.</span><span class="Identifier">popFirst</span><span class="Punctuation">(</span><span class="Punctuation">)</span>
    <span class="Keyword">while</span> <span class="Identifier">c</span><span class="Operator">.</span><span class="Identifier">running</span><span class="Punctuation">:</span>
      <span class="Identifier">c</span> <span class="Operator">=</span> <span class="Identifier">c</span><span class="Operator">.</span><span class="Identifier">fn</span><span class="Punctuation">(</span><span class="Identifier">c</span><span class="Punctuation">)</span>
</pre></p>
<p>Now we will introduce the last important part for building CPS programs, which is a special kind of function with the silly name &quot;cpsMagic&quot;. Hold on to your seat, because this is possibly the most confusing part of CPS:</p>
<p>Let's first describe what a <tt class="docutils literal"><span class="pre">cpsMagic</span></tt> function looks like: it</p>
<ul class="simple"><li>is annotated with the <tt class="docutils literal"><span class="pre">{.cpsMagic.}</span></tt> pragma</li>
<li>takes a continuation type as its first arguments</li>
<li>has the same continuation type as its return value</li>
<li>can only be called from within a CPS function</li>
</ul>
<p>When calling the function, you do not need to provide the first argument, as this will be injected by the CPS transformation at the call site. Also you do not need to consume its return value, as that is handled by CPS internally.</p>
<p>Now this is where the magic comes in: cpsMagic functions can be used to alter the program flow of a CPS function: it has access to the current continuation that is passed as its first argument, and it can return a continuation which will be used as the next leg in the trampoline.</p>
<p>That sounds complicated, so let's just write our first <tt class="docutils literal"><span class="pre">cpsMagic</span></tt> proc:</p>
<p><pre class="listing"><span class="Keyword">proc</span> <span class="Identifier">schedule</span><span class="Punctuation">(</span><span class="Identifier">c</span><span class="Punctuation">:</span> <span class="Identifier">MyCont</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Identifier">MyCont</span> <span class="Punctuation">{</span><span class="Operator">.</span><span class="Identifier">cpsMagic</span><span class="Operator">.</span><span class="Punctuation">}</span> <span class="Operator">=</span>
  <span class="Identifier">work</span><span class="Operator">.</span><span class="Identifier">addLast</span> <span class="Identifier">c</span>
  <span class="Keyword">return</span> <span class="Keyword">nil</span>
</pre></p>
<p>Let's see what happens when we call this:</p>
<ul class="simple"><li>The current continuation of the cps function will be passed as the first argument <tt class="docutils literal"><span class="pre">c</span></tt></li>
<li>The continuation <tt class="docutils literal"><span class="pre">c</span></tt> is added to <tt class="docutils literal"><span class="pre">work</span></tt>, the dequeue of continuations</li>
<li>It returns <tt class="docutils literal"><span class="pre">nil</span></tt> - which means &quot;no continuation&quot;. This will cause the trampoline that is running the continuation to terminate.</li>
</ul>
<p>Summarizing the above, the <tt class="docutils literal"><span class="pre">schedule()</span></tt> function will move the current continuation to the work queue, and stop the trampoline. The trampoline now has lost track of the continuation, as it is stored on the work queue instead so we can pick it up and suspend it later.</p>
<p>Remember that when calling a <tt class="docutils literal"><span class="pre">cpsMagic</span></tt> function from within CPS, we do not need to provide the first argument, nor handle the return type. To call the above function, simply do:</p>
<p><pre class="listing"><span class="Identifier">schedule</span><span class="Punctuation">(</span><span class="Punctuation">)</span>
</pre></p>
<p>It is now time to put the above pieces together. Let's take the example function we wrote before, and make the required changes:</p>
<ul class="simple"><li>Add the <tt class="docutils literal"><span class="pre">{.cps:MyCont.}</span></tt> pragma to make it into a CPS function</li>
<li>Call <tt class="docutils literal"><span class="pre">schedule()</span></tt> in the loop to suspend execution of the code by the trampoline. In the context of coroutines or iterators, this operation is usually called &quot;yield&quot;</li>
</ul>
<p>This is what it will look like now:</p>
<p><pre class="listing"><span class="Keyword">proc</span> <span class="Identifier">runner2</span><span class="Punctuation">(</span><span class="Identifier">name</span><span class="Punctuation">:</span> <span class="Identifier">string</span><span class="Punctuation">)</span> <span class="Punctuation">{</span><span class="Operator">.</span><span class="Identifier">cps</span><span class="Punctuation">:</span><span class="Identifier">MyCont</span><span class="Operator">.</span><span class="Punctuation">}</span><span class="Operator">=</span>
  <span class="Keyword">var</span> <span class="Identifier">i</span> <span class="Operator">=</span> <span class="DecNumber">0</span>
  <span class="Keyword">while</span> <span class="Identifier">i</span> <span class="Operator">&lt;</span> <span class="DecNumber">4</span><span class="Punctuation">:</span>
    <span class="Identifier">inc</span> <span class="Identifier">i</span>
    <span class="Identifier">echo</span> <span class="Identifier">name</span><span class="Punctuation">,</span> <span class="StringLit">&quot; &quot;</span><span class="Punctuation">,</span> <span class="Identifier">i</span>
    <span class="Identifier">schedule</span><span class="Punctuation">(</span><span class="Punctuation">)</span>
  <span class="Identifier">echo</span> <span class="StringLit">&quot;&quot;</span>
</pre></p>
<p>And that's it! Now we can instantiate the function into a continuation with the <tt class="docutils literal"><span class="pre">whelp</span></tt> macro. Let's do this twice to create two instances, and add the resulting continuations to the work queue:</p>
<p><pre class="listing"><span class="Identifier">work</span><span class="Operator">.</span><span class="Identifier">addLast</span> <span class="Identifier">whelp</span> <span class="Identifier">runner2</span><span class="Punctuation">(</span><span class="StringLit">&quot;donkey&quot;</span><span class="Punctuation">)</span>
<span class="Identifier">work</span><span class="Operator">.</span><span class="Identifier">addLast</span> <span class="Identifier">whelp</span> <span class="Identifier">runner2</span><span class="Punctuation">(</span><span class="StringLit">&quot;tiger&quot;</span><span class="Punctuation">)</span>
</pre></p>
<p>Now let's run this beast:</p>
<p><pre class="listing"><span class="Identifier">runwork</span><span class="Punctuation">(</span><span class="Punctuation">)</span>
</pre></p>
<p>And here is the output of our run:</p>
<p><pre class="listing">
donkey 1
tiger 1
donkey 2
tiger 2
donkey 3
tiger 3
donkey 4
tiger 4
</pre></p>

<h2 id="growing-your-own-continuations">Growing your own continuations</h2><p>The complete code for this chapter can be found at <a class="reference external" href="https://github.com/zevv/cpstut/blob/master/cpstut3.nim">https://github.com/zevv/cpstut/blob/master/cpstut3.nim</a></p>
<p>The example from the chapter above works just fine, but has one ugly drawback: the work queue is a global variable that is accessed from the <tt class="docutils literal"><span class="pre">cpsMagic</span></tt> proc. A nice way to solve this is to make the work queue a reference object, which is added to the continuation type itself: this way, every CPS function can access the work queue from the <tt class="docutils literal"><span class="pre">cpsMagic</span></tt> functions, without having to pass it around.</p>
<p>For this we need to make some changes to the code: first we define a reference type holding the work queue, and add a value of this type to our own continuation:</p>
<p><pre class="listing"><span class="Keyword">type</span>
  <span class="Identifier">Work</span> <span class="Operator">=</span> <span class="Keyword">ref</span> <span class="Keyword">object</span>
    <span class="Identifier">queue</span><span class="Punctuation">:</span> <span class="Identifier">Deque</span><span class="Punctuation">[</span><span class="Identifier">Continuation</span><span class="Punctuation">]</span>
  
  <span class="Identifier">MyCont</span> <span class="Operator">=</span> <span class="Keyword">ref</span> <span class="Keyword">object</span> <span class="Keyword">of</span> <span class="Identifier">Continuation</span>
    <span class="Identifier">work</span><span class="Punctuation">:</span> <span class="Identifier">Work</span>
</pre></p>
<p>When we now whelp new continuations, we need to make sure that the <tt class="docutils literal"><span class="pre">work</span></tt> pointer on the continuation points to a valid work queue. A little convenience function can be added for this, which we will use later to add our freshly whelped continuations to the work queue:</p>
<p><pre class="listing"><span class="Keyword">proc</span> <span class="Identifier">push</span><span class="Punctuation">(</span><span class="Identifier">work</span><span class="Punctuation">:</span> <span class="Identifier">Work</span><span class="Punctuation">,</span> <span class="Identifier">c</span><span class="Punctuation">:</span> <span class="Identifier">MyCont</span><span class="Punctuation">)</span> <span class="Operator">=</span>
  <span class="Identifier">work</span><span class="Operator">.</span><span class="Identifier">queue</span><span class="Operator">.</span><span class="Identifier">addLast</span> <span class="Identifier">c</span>
  <span class="Identifier">c</span><span class="Operator">.</span><span class="Identifier">work</span> <span class="Operator">=</span> <span class="Identifier">work</span>
</pre></p>
<p>The schedule function is now changed not to add the continuation to the global work queue, but to the queue that is stored on the continuation instead:</p>
<p><pre class="listing"><span class="Keyword">proc</span> <span class="Identifier">schedule</span><span class="Punctuation">(</span><span class="Identifier">c</span><span class="Punctuation">:</span> <span class="Identifier">MyCont</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Identifier">MyCont</span> <span class="Punctuation">{</span><span class="Operator">.</span><span class="Identifier">cpsMagic</span><span class="Operator">.</span><span class="Punctuation">}</span> <span class="Operator">=</span>
  <span class="Identifier">c</span><span class="Operator">.</span><span class="Identifier">work</span><span class="Operator">.</span><span class="Identifier">queue</span><span class="Operator">.</span><span class="Identifier">addLast</span> <span class="Identifier">c</span>
  <span class="Keyword">return</span> <span class="Keyword">nil</span>
</pre></p>
<p>The trampolining of the work queue was done in the main code before, let's move this to a proc instead:</p>
<p><pre class="listing"><span class="Keyword">proc</span> <span class="Identifier">run</span><span class="Punctuation">(</span><span class="Identifier">work</span><span class="Punctuation">:</span> <span class="Identifier">Work</span><span class="Punctuation">)</span> <span class="Operator">=</span>
  <span class="Keyword">while</span> <span class="Identifier">work</span><span class="Operator">.</span><span class="Identifier">queue</span><span class="Operator">.</span><span class="Identifier">len</span> <span class="Operator">&gt;</span> <span class="DecNumber">0</span><span class="Punctuation">:</span>
    <span class="Keyword">var</span> <span class="Identifier">c</span> <span class="Operator">=</span> <span class="Identifier">work</span><span class="Operator">.</span><span class="Identifier">queue</span><span class="Operator">.</span><span class="Identifier">popFirst</span><span class="Punctuation">(</span><span class="Punctuation">)</span>
    <span class="Keyword">while</span> <span class="Identifier">c</span><span class="Operator">.</span><span class="Identifier">running</span><span class="Punctuation">:</span>
      <span class="Identifier">c</span> <span class="Operator">=</span> <span class="Identifier">c</span><span class="Operator">.</span><span class="Identifier">fn</span><span class="Punctuation">(</span><span class="Identifier">c</span><span class="Punctuation">)</span>
</pre></p>
<p>And this completes all the pieces of the puzzle: we can now create one instance # of a work queue, add the fresh continuations to them and run the work queue like this:</p>
<p><pre class="listing"><span class="Keyword">var</span> <span class="Identifier">mywork</span> <span class="Operator">=</span> <span class="Identifier">Work</span><span class="Punctuation">(</span><span class="Punctuation">)</span>
<span class="Identifier">mywork</span><span class="Operator">.</span><span class="Identifier">push</span> <span class="Identifier">whelp</span> <span class="Identifier">runner2</span><span class="Punctuation">(</span><span class="StringLit">&quot;donkey&quot;</span><span class="Punctuation">)</span>
<span class="Identifier">mywork</span><span class="Operator">.</span><span class="Identifier">push</span> <span class="Identifier">whelp</span> <span class="Identifier">runner2</span><span class="Punctuation">(</span><span class="StringLit">&quot;tiger&quot;</span><span class="Punctuation">)</span>
<span class="Identifier">mywork</span><span class="Operator">.</span><span class="Identifier">run</span><span class="Punctuation">(</span><span class="Punctuation">)</span>
</pre></p>

<h2 id="todo">Todo</h2><p>TODO: {.cpsVoodo.}</p>



    <div class="row">
      <div class="twelve-columns footer">
        <span class="nim-sprite"></span>
        <br/>
        <small style="color: var(--hint);">Made with Nim. Generated: 2021-07-02 19:02:40 UTC</small>
      </div>
    </div>
  </div>
</div>

</body>
</html>
